{% extends "base.html" %}

{% block title %}定时提醒 - XXXBOT管理后台{% endblock %}

{% block extra_css %}
<style>
    .reminder-card {
        transition: all 0.3s ease;
        border-left: 4px solid #3498db;
    }
    
    .reminder-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .reminder-card.active {
        border-left-color: #2ecc71;
    }
    
    .reminder-card.completed {
        border-left-color: #95a5a6;
        opacity: 0.7;
    }
    
    .reminder-card.expired {
        border-left-color: #e74c3c;
    }
    
    .status-badge {
        font-size: 10px;
    }
    
    .timer-display {
        font-family: 'Roboto Mono', monospace;
        font-weight: 600;
    }
    
    .reminder-actions {
        opacity: 0.3;
        transition: all 0.2s ease;
    }
    
    .reminder-card:hover .reminder-actions {
        opacity: 1;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        border-radius: 10px;
        background-color: rgba(255,255,255,0.5);
    }
    
    .empty-state i {
        font-size: 4rem;
        color: #ddd;
        margin-bottom: 20px;
    }
    
    /* 分类标签样式 */
    .category-badge {
        font-size: 11px;
        padding: 5px 10px;
        border-radius: 30px;
    }
    
    .category-work {
        background-color: rgba(52, 152, 219, 0.2);
        color: #2980b9;
    }
    
    .category-personal {
        background-color: rgba(46, 204, 113, 0.2);
        color: #27ae60;
    }
    
    .category-important {
        background-color: rgba(231, 76, 60, 0.2);
        color: #c0392b;
    }
    
    .category-other {
        background-color: rgba(155, 89, 182, 0.2);
        color: #8e44ad;
    }
</style>
{% endblock %}

{% block page_title %}定时提醒{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card mat-card shadow-sm mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0"><i class="bi bi-clock-history me-2"></i>定时提醒管理</h5>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newReminderModal">
                            <i class="bi bi-plus-circle me-1"></i> 新建提醒
                        </button>
                    </div>
                    
                    <!-- 筛选器 -->
                    <div class="row mb-4">
                        <div class="col-md-3 mb-2">
                            <div class="input-group">
                                <span class="input-group-text bg-light border-0">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text" id="searchReminder" class="form-control border-0 bg-light" placeholder="搜索提醒...">
                            </div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <select id="statusFilter" class="form-select border-0 bg-light">
                                <option value="all">所有状态</option>
                                <option value="active">进行中</option>
                                <option value="completed">已完成</option>
                                <option value="expired">已过期</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-2">
                            <select id="categoryFilter" class="form-select border-0 bg-light">
                                <option value="all">所有分类</option>
                                <option value="work">工作</option>
                                <option value="personal">个人</option>
                                <option value="important">重要</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-2">
                            <select id="sortOrder" class="form-select border-0 bg-light">
                                <option value="dueDateAsc">最早到期优先</option>
                                <option value="dueDateDesc">最晚到期优先</option>
                                <option value="createdDateDesc">最近创建优先</option>
                                <option value="createdDateAsc">最早创建优先</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 提醒列表 -->
                    <div id="remindersList">
                        <div class="empty-state" id="emptyState" style="display: none;">
                            <i class="bi bi-calendar-x"></i>
                            <h5>没有找到提醒</h5>
                            <p>创建新提醒来跟踪重要事件吧</p>
                            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newReminderModal">
                                <i class="bi bi-plus-circle me-1"></i> 创建提醒
                            </button>
                        </div>
                        
                        <div id="remindersContainer" class="row"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 新建提醒模态框 -->
<div class="modal fade" id="newReminderModal" tabindex="-1" aria-labelledby="newReminderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newReminderModalLabel">新建提醒</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="reminderForm">
                    <div class="mb-3">
                        <label for="reminderTitle" class="form-label">标题</label>
                        <input type="text" class="form-control" id="reminderTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="reminderDescription" class="form-label">描述 (可选)</label>
                        <textarea class="form-control" id="reminderDescription" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="reminderDate" class="form-label">日期</label>
                            <input type="date" class="form-control" id="reminderDate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="reminderTime" class="form-label">时间</label>
                            <input type="time" class="form-control" id="reminderTime" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="reminderCategory" class="form-label">分类</label>
                        <select class="form-select" id="reminderCategory">
                            <option value="work">工作</option>
                            <option value="personal">个人</option>
                            <option value="important">重要</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="reminderRecipients" class="form-label">接收者</label>
                        <select class="form-select" id="reminderRecipients" multiple size="3">
                            <!-- 这里会动态加载接收者 -->
                        </select>
                        <small class="form-text text-muted">选择多个接收者时按住Ctrl键</small>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="reminderNotify">
                        <label class="form-check-label" for="reminderNotify">
                            到期时在网页上提醒
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveReminder">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑提醒模态框 -->
<div class="modal fade" id="editReminderModal" tabindex="-1" aria-labelledby="editReminderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editReminderModalLabel">编辑提醒</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editReminderForm">
                    <input type="hidden" id="editReminderId">
                    <div class="mb-3">
                        <label for="editReminderTitle" class="form-label">标题</label>
                        <input type="text" class="form-control" id="editReminderTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="editReminderDescription" class="form-label">描述 (可选)</label>
                        <textarea class="form-control" id="editReminderDescription" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editReminderDate" class="form-label">日期</label>
                            <input type="date" class="form-control" id="editReminderDate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editReminderTime" class="form-label">时间</label>
                            <input type="time" class="form-control" id="editReminderTime" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editReminderCategory" class="form-label">分类</label>
                        <select class="form-select" id="editReminderCategory">
                            <option value="work">工作</option>
                            <option value="personal">个人</option>
                            <option value="important">重要</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editReminderRecipients" class="form-label">接收者</label>
                        <select class="form-select" id="editReminderRecipients" multiple size="3">
                            <!-- 这里会动态加载接收者 -->
                        </select>
                        <small class="form-text text-muted">选择多个接收者时按住Ctrl键</small>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="editReminderNotify">
                        <label class="form-check-label" for="editReminderNotify">
                            到期时在网页上提醒
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="updateReminder">更新</button>
            </div>
        </div>
    </div>
</div>

<!-- 提醒详情模态框 -->
<div class="modal fade" id="reminderDetailModal" tabindex="-1" aria-labelledby="reminderDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reminderDetailModalLabel">提醒详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="reminderDetailContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="editReminderBtn">编辑</button>
            </div>
        </div>
    </div>
</div>

<!-- 引入jQuery -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>

<!-- 定时提醒的JavaScript -->
<script>
    $(document).ready(function() {
        // 加载联系人到选择框
        loadContacts();
        
        // 加载所有提醒
        loadReminders();
        
        // 绑定保存提醒按钮
        $('#saveReminder').click(function() {
            saveReminder();
        });
        
        // 绑定更新提醒按钮
        $('#updateReminder').click(function() {
            updateReminder();
        });
        
        // 绑定编辑按钮
        $('#editReminderBtn').click(function() {
            const reminderId = $(this).data('reminderId');
            $('#reminderDetailModal').modal('hide');
            openEditModal(reminderId);
        });
        
        // 绑定筛选器变化事件
        $('#searchReminder, #statusFilter, #categoryFilter, #sortOrder').on('input change', function() {
            filterReminders();
        });
        
        // 设置定时器，每分钟更新一次倒计时
        setInterval(updateCountdowns, 60000);
    });
    
    // 加载联系人列表
    function loadContacts() {
        $.ajax({
            url: '/api/contacts',
            method: 'GET',
            success: function(response) {
                if (response.success && response.data) {
                    populateContacts(response.data);
                }
            },
            error: function(error) {
                console.error('获取联系人失败:', error);
            }
        });
    }
    
    // 填充联系人到选择框
    function populateContacts(contacts) {
        const recipients = $('#reminderRecipients, #editReminderRecipients');
        recipients.empty();
        
        // 添加系统提醒选项（只在网页显示）
        recipients.append(`<option value="system">系统提醒（仅网页）</option>`);
        
        if (contacts.length > 0) {
            contacts.forEach(contact => {
                recipients.append(`<option value="${contact.wxid}">${contact.nickname || contact.wxid}</option>`);
            });
        }
    }
    
    // 加载所有提醒
    function loadReminders() {
        $.ajax({
            url: '/api/reminders',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    displayReminders(response.data);
                } else {
                    showEmptyState(true);
                }
            },
            error: function(error) {
                console.error('获取提醒失败:', error);
                showEmptyState(true);
            }
        });
    }
    
    // 显示提醒列表
    function displayReminders(reminders) {
        const container = $('#remindersContainer');
        container.empty();
        
        if (!reminders || reminders.length === 0) {
            showEmptyState(true);
            return;
        }
        
        showEmptyState(false);
        
        reminders.forEach(reminder => {
            const dueDateTime = new Date(reminder.due_date);
            const now = new Date();
            
            // 确定提醒状态
            let status = 'active';
            let statusText = '进行中';
            let statusClass = 'bg-primary';
            
            if (reminder.completed) {
                status = 'completed';
                statusText = '已完成';
                statusClass = 'bg-secondary';
            } else if (dueDateTime < now) {
                status = 'expired';
                statusText = '已过期';
                statusClass = 'bg-danger';
            }
            
            // 计算倒计时
            let countdownText = getCountdownText(dueDateTime);
            
            // 获取分类样式
            const categoryClass = `category-${reminder.category || 'other'}`;
            const categoryText = getCategoryText(reminder.category);
            
            const card = `
                <div class="col-md-6 col-lg-4 mb-4 reminder-item" 
                     data-id="${reminder.id}" 
                     data-status="${status}" 
                     data-category="${reminder.category || 'other'}"
                     data-title="${reminder.title}"
                     data-due-date="${reminder.due_date}">
                    <div class="card reminder-card shadow-sm ${status}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0 text-truncate">${reminder.title}</h5>
                                <div>
                                    <span class="badge ${statusClass} status-badge">${statusText}</span>
                                </div>
                            </div>
                            <div class="mb-2">
                                <span class="badge category-badge ${categoryClass}">${categoryText}</span>
                            </div>
                            <p class="card-text text-truncate">${reminder.description || '无描述'}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="timer-display">
                                    <i class="bi bi-clock"></i> 
                                    <span class="countdown-text">${countdownText}</span>
                                </div>
                                <div class="reminder-actions">
                                    <button class="btn btn-sm btn-outline-primary view-reminder" data-id="${reminder.id}">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success ${reminder.completed ? '' : 'complete-reminder'}" data-id="${reminder.id}" ${reminder.completed ? 'disabled' : ''}>
                                        <i class="bi bi-check-circle"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-reminder" data-id="${reminder.id}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.append(card);
        });
        
        // 绑定事件
        bindReminderEvents();
        
        // 应用初始筛选
        filterReminders();
    }
    
    // 格式化倒计时文本
    function getCountdownText(dueDate) {
        const now = new Date();
        const diff = dueDate - now;
        
        if (diff < 0) {
            const pastDiff = Math.abs(diff);
            const days = Math.floor(pastDiff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((pastDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            
            if (days > 0) {
                return `已过期 ${days} 天`;
            } else {
                return `已过期 ${hours} 小时`;
            }
        }
        
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        
        if (days > 0) {
            return `还剩 ${days} 天 ${hours} 小时`;
        } else if (hours > 0) {
            return `还剩 ${hours} 小时 ${minutes} 分钟`;
        } else {
            return `还剩 ${minutes} 分钟`;
        }
    }
    
    // 获取分类文本
    function getCategoryText(category) {
        switch(category) {
            case 'work': return '工作';
            case 'personal': return '个人';
            case 'important': return '重要';
            case 'other': 
            default: return '其他';
        }
    }
    
    // 显示或隐藏空状态
    function showEmptyState(show) {
        if (show) {
            $('#emptyState').show();
            $('#remindersContainer').hide();
        } else {
            $('#emptyState').hide();
            $('#remindersContainer').show();
        }
    }
    
    // 绑定提醒卡片事件
    function bindReminderEvents() {
        // 查看详情
        $('.view-reminder').click(function() {
            const reminderId = $(this).data('id');
            viewReminderDetail(reminderId);
        });
        
        // 标记完成
        $('.complete-reminder').click(function() {
            const reminderId = $(this).data('id');
            completeReminder(reminderId);
        });
        
        // 删除提醒
        $('.delete-reminder').click(function() {
            const reminderId = $(this).data('id');
            deleteReminder(reminderId);
        });
        
        // 点击卡片也可以查看详情
        $('.reminder-card').click(function(e) {
            if (!$(e.target).closest('button').length) {
                const reminderId = $(this).closest('.reminder-item').data('id');
                viewReminderDetail(reminderId);
            }
        });
    }
    
    // 查看提醒详情
    function viewReminderDetail(reminderId) {
        $.ajax({
            url: `/api/reminders/${reminderId}`,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    displayReminderDetail(response.data);
                }
            },
            error: function(error) {
                console.error('获取提醒详情失败:', error);
            }
        });
    }
    
    // 显示提醒详情
    function displayReminderDetail(reminder) {
        const dueDateTime = new Date(reminder.due_date);
        const createdDateTime = new Date(reminder.created_at);
        
        let statusText = '进行中';
        let statusClass = 'text-primary';
        
        if (reminder.completed) {
            statusText = '已完成';
            statusClass = 'text-secondary';
        } else if (dueDateTime < new Date()) {
            statusText = '已过期';
            statusClass = 'text-danger';
        }
        
        let recipientsText = '无';
        if (reminder.recipients && reminder.recipients.length > 0) {
            recipientsText = reminder.recipients.map(r => r.name || r.id).join(', ');
        }
        
        const detailHtml = `
            <div class="reminder-detail">
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <h3>${reminder.title}</h3>
                        <span class="badge ${statusClass === 'text-primary' ? 'bg-primary' : statusClass === 'text-secondary' ? 'bg-secondary' : 'bg-danger'}">${statusText}</span>
                    </div>
                    <span class="badge category-badge category-${reminder.category || 'other'}">${getCategoryText(reminder.category)}</span>
                </div>
                <div class="mb-3">
                    <p><strong>描述:</strong><br>${reminder.description || '无描述'}</p>
                </div>
                <div class="mb-3">
                    <p><strong>到期时间:</strong><br>${dueDateTime.toLocaleString()}</p>
                </div>
                <div class="mb-3">
                    <p><strong>创建时间:</strong><br>${createdDateTime.toLocaleString()}</p>
                </div>
                <div class="mb-3">
                    <p><strong>接收者:</strong><br>${recipientsText}</p>
                </div>
                <div class="mb-3">
                    <p><strong>网页提醒:</strong><br>${reminder.notify_browser ? '启用' : '禁用'}</p>
                </div>
            </div>
        `;
        
        $('#reminderDetailContent').html(detailHtml);
        $('#editReminderBtn').data('reminderId', reminder.id);
        $('#reminderDetailModal').modal('show');
    }
    
    // 保存新提醒
    function saveReminder() {
        const title = $('#reminderTitle').val();
        const description = $('#reminderDescription').val();
        const date = $('#reminderDate').val();
        const time = $('#reminderTime').val();
        const category = $('#reminderCategory').val();
        const recipients = Array.from($('#reminderRecipients option:selected')).map(opt => opt.value);
        const notifyBrowser = $('#reminderNotify').is(':checked');
        
        if (!title || !date || !time) {
            alert('请填写必填字段');
            return;
        }
        
        const dueDate = `${date}T${time}:00`;
        
        const reminderData = {
            title,
            description,
            due_date: dueDate,
            category,
            recipients,
            notify_browser: notifyBrowser
        };
        
        $.ajax({
            url: '/api/reminders',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(reminderData),
            success: function(response) {
                if (response.success) {
                    $('#newReminderModal').modal('hide');
                    resetReminderForm();
                    loadReminders();
                } else {
                    alert('创建提醒失败: ' + (response.message || '未知错误'));
                }
            },
            error: function(error) {
                console.error('创建提醒失败:', error);
                alert('创建提醒失败: ' + (error.responseJSON?.message || '未知错误'));
            }
        });
    }
    
    // 重置表单
    function resetReminderForm() {
        $('#reminderForm')[0].reset();
    }
    
    // 打开编辑模态框
    function openEditModal(reminderId) {
        $.ajax({
            url: `/api/reminders/${reminderId}`,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    populateEditForm(response.data);
                    $('#editReminderModal').modal('show');
                }
            },
            error: function(error) {
                console.error('获取提醒详情失败:', error);
            }
        });
    }
    
    // 填充编辑表单
    function populateEditForm(reminder) {
        const dueDateTime = new Date(reminder.due_date);
        const dueDate = dueDateTime.toISOString().split('T')[0];
        const dueTime = dueDateTime.toTimeString().split(' ')[0].substr(0, 5);
        
        $('#editReminderId').val(reminder.id);
        $('#editReminderTitle').val(reminder.title);
        $('#editReminderDescription').val(reminder.description);
        $('#editReminderDate').val(dueDate);
        $('#editReminderTime').val(dueTime);
        $('#editReminderCategory').val(reminder.category || 'other');
        $('#editReminderNotify').prop('checked', reminder.notify_browser);
        
        // 设置选中的接收者
        if (reminder.recipients) {
            const recipientIds = reminder.recipients.map(r => r.id);
            $('#editReminderRecipients option').each(function() {
                $(this).prop('selected', recipientIds.includes($(this).val()));
            });
        }
    }
    
    // 更新提醒
    function updateReminder() {
        const id = $('#editReminderId').val();
        const title = $('#editReminderTitle').val();
        const description = $('#editReminderDescription').val();
        const date = $('#editReminderDate').val();
        const time = $('#editReminderTime').val();
        const category = $('#editReminderCategory').val();
        const recipients = Array.from($('#editReminderRecipients option:selected')).map(opt => opt.value);
        const notifyBrowser = $('#editReminderNotify').is(':checked');
        
        if (!title || !date || !time) {
            alert('请填写必填字段');
            return;
        }
        
        const dueDate = `${date}T${time}:00`;
        
        const reminderData = {
            title,
            description,
            due_date: dueDate,
            category,
            recipients,
            notify_browser: notifyBrowser
        };
        
        $.ajax({
            url: `/api/reminders/${id}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(reminderData),
            success: function(response) {
                if (response.success) {
                    $('#editReminderModal').modal('hide');
                    loadReminders();
                } else {
                    alert('更新提醒失败: ' + (response.message || '未知错误'));
                }
            },
            error: function(error) {
                console.error('更新提醒失败:', error);
                alert('更新提醒失败: ' + (error.responseJSON?.message || '未知错误'));
            }
        });
    }
    
    // 标记提醒为已完成
    function completeReminder(reminderId) {
        $.ajax({
            url: `/api/reminders/${reminderId}/complete`,
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    loadReminders();
                } else {
                    alert('更新提醒状态失败: ' + (response.message || '未知错误'));
                }
            },
            error: function(error) {
                console.error('更新提醒状态失败:', error);
                alert('更新提醒状态失败: ' + (error.responseJSON?.message || '未知错误'));
            }
        });
    }
    
    // 删除提醒
    function deleteReminder(reminderId) {
        if (confirm('确定要删除这个提醒吗？')) {
            $.ajax({
                url: `/api/reminders/${reminderId}`,
                method: 'DELETE',
                success: function(response) {
                    if (response.success) {
                        loadReminders();
                    } else {
                        alert('删除提醒失败: ' + (response.message || '未知错误'));
                    }
                },
                error: function(error) {
                    console.error('删除提醒失败:', error);
                    alert('删除提醒失败: ' + (error.responseJSON?.message || '未知错误'));
                }
            });
        }
    }
    
    // 筛选提醒
    function filterReminders() {
        const searchQuery = $('#searchReminder').val().toLowerCase();
        const statusFilter = $('#statusFilter').val();
        const categoryFilter = $('#categoryFilter').val();
        const sortOrder = $('#sortOrder').val();
        
        let visibleCount = 0;
        
        $('.reminder-item').each(function() {
            const $item = $(this);
            const itemTitle = $item.data('title').toLowerCase();
            const itemStatus = $item.data('status');
            const itemCategory = $item.data('category');
            
            const matchesSearch = !searchQuery || itemTitle.includes(searchQuery);
            const matchesStatus = statusFilter === 'all' || itemStatus === statusFilter;
            const matchesCategory = categoryFilter === 'all' || itemCategory === categoryFilter;
            
            if (matchesSearch && matchesStatus && matchesCategory) {
                $item.show();
                visibleCount++;
            } else {
                $item.hide();
            }
        });
        
        // 排序
        const $container = $('#remindersContainer');
        const $items = $('.reminder-item:visible').detach();
        
        $items.sort(function(a, b) {
            const $a = $(a);
            const $b = $(b);
            
            const aDate = new Date($a.data('due-date'));
            const bDate = new Date($b.data('due-date'));
            
            if (sortOrder === 'dueDateAsc') {
                return aDate - bDate;
            } else if (sortOrder === 'dueDateDesc') {
                return bDate - aDate;
            }
            
            // TODO: 实现其他排序方式
            
            return 0;
        });
        
        $container.append($items);
        
        // 显示空状态
        showEmptyState(visibleCount === 0);
    }
    
    // 更新所有倒计时
    function updateCountdowns() {
        $('.countdown-text').each(function() {
            const $item = $(this).closest('.reminder-item');
            const dueDate = new Date($item.data('due-date'));
            $(this).text(getCountdownText(dueDate));
        });
    }
</script>
{% endblock %} 